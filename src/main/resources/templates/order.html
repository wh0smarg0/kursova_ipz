<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kyiv Gastrobar - Замовлення</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f8f8;
        }

        header {
            background-color: #333;
            padding: 10px 20px;
        }

        header nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        header nav ul li {
            margin-right: 20px;
        }

        header nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }

        header nav ul li a.active {
            text-decoration: underline;
        }

        .container {
            max-width: 600px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-name {
            flex: 1;
            font-size: 16px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-controls button {
            width: 25px;
            height: 25px;
            background-color: #eee;
            border: 1px solid #ccc;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
        }

        .item-price {
            font-weight: bold;
            font-size: 16px;
        }

        .total {
            text-align: right;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
        }

        .place-order {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #333;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            text-align: center;
            border-radius: 4px;
        }

        .place-order:hover {
            background-color: #555;
        }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 10px 0;
            position: fixed;
            width: 100%;
            bottom: 0;
        }

        /* Стилі для модального вікна і форми */
        #customer-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            width: 80%;
            max-width: 500px;
        }

        #customer-modal h2 {
            margin-bottom: 20px;
        }

        #customer-modal form {
            display: flex;
            flex-direction: column;
        }

        #customer-modal label {
            font-weight: bold;
            margin-bottom: 8px;
        }

        #customer-modal input {
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        #customer-modal input:focus {
            border-color: #333;
            outline: none;
        }

        #customer-modal button {
            padding: 10px;
            background-color: #333;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 10px;
        }

        #customer-modal button:hover {
            background-color: #555;
        }

        /* Фон для затемнення під час показу модального вікна */
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
<header>
    <nav>
        <ul>
            <li><a href="api.html">Головна</a></li>
            <li><a href="menu.html">Меню</a></li>
            <li><a href="order.html" class="active">Замовлення</a></li>
            <li><a href="contact.html">Контакти</a></li>
        </ul>
    </nav>
</header>

<div class="container">
    <h1>Ваше Замовлення</h1>
    <div id="order-items">
        <!-- Замовлені страви будуть тут -->
    </div>
    <div class="total">
        Загальна сума: <span id="total-price">0 ₴</span>
    </div>
    <button type="button" id="submitOrder" class="place-order">Оформити замовлення</button>
</div>

<!-- Вікно для введення даних клієнта -->
<div id="overlay"></div>
<div id="customer-modal">
    <h2>Введіть ваші дані:</h2>
    <form id="customer-form">
        <label for="customer-name">Name:</label>
        <input type="text" id="customer-name" name="customer-name" required>

        <label for="customer-email">Email:</label>
        <input type="email" id="customer-email" name="customer-email" required>

        <label for="customer-phone">Phone:</label>
        <input type="text" id="customer-phone" name="customer-phone" required>

        <label for="customer-address">Address:</label>
        <input type="text" id="customer-address" name="customer-address" required>

        <button type="button" id="submitCustomerDetails" class="btn">Submit</button>
    </form>
</div>

<footer>
    <p>&copy; 2025 KYIV GASTROBAR. Всі права захищені.</p>
</footer>

<script>
    let selectedItems = JSON.parse(localStorage.getItem('selectedItems')) || [];

    function renderOrder() {
        const orderItemsContainer = document.getElementById('order-items');
        orderItemsContainer.innerHTML = '';
        let totalPrice = 0;

        selectedItems.forEach(item => {
            const orderItemDiv = document.createElement('div');
            orderItemDiv.classList.add('order-item');
            orderItemDiv.innerHTML = `
                <div class="item-name">${item.name}</div>
                <div class="quantity-controls">
                    <button onclick="updateQuantity('${item.name}', -1)">-</button>
                    <span>${item.quantity}</span>
                    <button onclick="updateQuantity('${item.name}', 1)">+</button>
                </div>
                <div class="item-price">${item.price * item.quantity} ₴</div>
            `;
            orderItemsContainer.appendChild(orderItemDiv);
            totalPrice += item.price * item.quantity;
        });

        document.getElementById('total-price').textContent = `${totalPrice} ₴`;
    }

    function updateQuantity(name, change) {
        const item = selectedItems.find(i => i.name === name);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                selectedItems = selectedItems.filter(i => i.name !== name);
            }
            localStorage.setItem('selectedItems', JSON.stringify(selectedItems));
            renderOrder();
        }
    }

    document.getElementById('submitOrder').addEventListener('click', () => {
        document.getElementById('customer-modal').style.display = 'block';
    });

    // Обробка даних клієнта перед створенням замовлення
    document.getElementById('submitCustomerDetails').addEventListener('click', async () => {
        try {
            const customerName = document.getElementById('customer-name').value;
            const customerEmail = document.getElementById('customer-email').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const customerAddress = document.getElementById('customer-address').value;

            if (!customerName || !customerEmail || !customerPhone || !customerAddress) {
                alert('Будь ласка, заповніть всі поля форми.');
                return;
            }

            console.log('Customer details:', { customerName, customerEmail, customerPhone, customerAddress });

            // 1. Додавання даних клієнта
            const customerResponse = await fetch('http://localhost:8080/customers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: customerName, email: customerEmail, phone: customerPhone, address: customerAddress })
            });

            if (!customerResponse.ok) throw new Error('Failed to add customer details');
            const customer = await customerResponse.json();
            console.log('Customer added:', customer);

            // 2. Створення нового замовлення
            const orderResponse = await fetch('http://localhost:8080/order-table', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status: 'Pending',
                    customer : customer.name
                })
            });

            if (!orderResponse.ok) throw new Error('Failed to create order');
            const order = await orderResponse.json();
            console.log('Order created:', order);

            // 3. Додавання пунктів замовлення
            const selectedItems = JSON.parse(localStorage.getItem('selectedItems')) || [];
            for (const item of selectedItems) {
                if (!item.menuItem || !item.menuItem.id) {
                    console.error('Menu Item ID is missing or invalid');
                    continue;  // Пропускаем текущий пункт, если отсутствует ID
                }

                console.log("Sending item:", item);
                console.log("Menu item ID:", item.menuItem?.id);  // Проверка, что id присутствует

                const payload = {
                    quantity: Number(item.quantity), // Кількість
                    menuItemId: menuItem.id,
                    order: order.id  // ID замовлення
                };

                console.log("Дані, що відправляються:", JSON.stringify(payload));

                const response = await fetch("http://localhost:8080/order-items", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    console.error("Помилка сервера:", await response.text());
                    throw new Error("Failed to add order item");
                }

                console.log("Order item added:", payload);
            }

            // 4. Оновлення статусу доставки
            const deliveryResponse = await fetch('http://localhost:8080/delivery', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    address: customerAddress,
                    delivery_status: 'Pending',
                    order_id: { id: order.id }
                })
            });

            if (!deliveryResponse.ok) throw new Error('Failed to create delivery');
            console.log('Delivery created for order:', order.id);

            alert('Замовлення успішно оформлено!');
            document.getElementById('customer-modal').style.display = 'none';
            localStorage.removeItem('selectedItems');
        } catch (error) {
            console.error('Error submitting customer details:', error);
            alert('Failed to submit customer details. Please try again.');
        }
    });

    window.onload = renderOrder;

    // Показати модальне вікно
    document.getElementById("submitOrder").onclick = function () {
        document.getElementById("overlay").style.display = "block";
        document.getElementById("customer-modal").style.display = "block";
    }

    // Закрити модальне вікно
    document.getElementById("overlay").onclick = function () {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("customer-modal").style.display = "none";
    }

</script>
</body>
</html>
